-- Inserta cat√°logo de cuentas contables y parametrizaciones por proveedor
WITH cuentas AS (
    SELECT * FROM (VALUES
        ('231051102511', 'CON RTE FTE DEL 11%', 'D', 'SUBTOTAL', NULL, NULL),
        ('231051102535', 'SIN RTE FTE POR LEY', 'D', 'SUBTOTAL', NULL, NULL),
        ('231051103011', 'CON RTE FTE DEL 11%', 'D', 'SUBTOTAL', NULL, NULL),
        ('231051351501', 'GASTOS FINANCIEROS', 'D', 'SUBTOTAL', NULL, NULL),
        ('231051351532', 'ASISTENCIA TECNICA  SERVICIOS', 'D', 'SUBTOTAL', NULL, NULL),
        ('231051401035', 'SIN RTE FTE POR LEY', 'D', 'SUBTOTAL', NULL, NULL),
        ('231051452530', 'SIN RTE FTE SERVICIO MENOR', 'D', 'SUBTOTAL', NULL, NULL),
        ('231051951035', 'SIN RTE FTE POR LEY', 'D', 'SUBTOTAL', NULL, NULL),
        ('231051953004', 'CON RTE FTE DEL 4%', 'D', 'SUBTOTAL', NULL, NULL),
        ('231051953031', 'SIN RTE FTE COMPRA MENOR CUANTIA', 'D', 'SUBTOTAL', NULL, NULL),
        ('231052201032', 'AUTORRETENEDORES', 'D', 'SUBTOTAL', NULL, NULL),
        ('231052301032', 'AUTORRETENEDORES', 'D', 'SUBTOTAL', NULL, NULL),
        ('231052351535', 'SIN RTE FTE POR LEY', 'D', 'SUBTOTAL', NULL, NULL),
        ('23105235351032', 'AUTORRETENEDORES', 'D', 'SUBTOTAL', NULL, NULL),
        ('231052355003', 'CON RTE FTE DEL 3.5%', 'D', 'SUBTOTAL', NULL, NULL),
        ('231052356030', 'SIN RTE FTE SERVICIO MENOR', 'D', 'SUBTOTAL', NULL, NULL),
        ('23105295050111', 'CON RTE FTE DEL 11%', 'D', 'SUBTOTAL', NULL, NULL),
        ('231053051534', 'SIN RTE FTE VIG.SUPERBANCARIA', 'D', 'SUBTOTAL', NULL, NULL),
        ('231053059501', 'OTROS FINANCIEROS', 'D', 'SUBTOTAL', NULL, NULL),
        ('231053152007', 'IMPUESTO AL CONSUMO', 'D', 'INC', NULL, NULL),
        ('23106145200435', 'SIN RTE FTE POR LEY', 'D', 'SUBTOTAL', NULL, NULL),
        ('23106145200604', 'CON RTE FTE DEL 4%', 'D', 'SUBTOTAL', NULL, NULL),
        ('23106145200632', 'AUTORRETENEDOR', 'D', 'SUBTOTAL', NULL, NULL),
        ('23106145201003', 'CON RTE FTE DEL 3.5%', 'D', 'SUBTOTAL', NULL, NULL),
        ('23106145201032', 'AUTORRETENEDORES', 'D', 'SUBTOTAL', NULL, NULL),
        ('23106145201235', 'SIN RTE FTE POR LEY', 'D', 'SUBTOTAL', NULL, NULL),
        ('23106145201332', 'AUTORRETENEDORES', 'D', 'SUBTOTAL', NULL, NULL),
        ('23106145303532', 'SERV CARGA AUTORETENEDORES', 'D', 'SUBTOTAL', NULL, NULL),
        ('23106145303535', 'SIN RETENCION POR LEY', 'D', 'SUBTOTAL', NULL, NULL),
        ('23359526', 'GASTOS/COSTOS COP', 'C', 'TOTAL_NETO', NULL, NULL),
        ('23651511', 'CON RTE FTE DEL 11%', 'C', 'RETEFUENTE', '11.0000', 'PORCENTAJE'),
        ('23652011', 'CON RTE FTE DEL 11%', 'C', 'RETEFUENTE', '11.0000', 'PORCENTAJE'),
        ('23652504', 'CON RTE FTE DEL 3.5%', 'C', 'RETEFUENTE', '3.5000', 'PORCENTAJE'),
        ('23652505', 'CON RTE FTE DEL 4%', 'C', 'RETEFUENTE', '4.0000', 'PORCENTAJE'),
        ('2367010212', 'CON RTE IVA DEL 15%', 'C', 'RETEIVA', '15.0000', 'PORCENTAJE'),
        ('23680104', 'CON RTE ICA DEL 0.414%', 'C', 'RETEICA', '0.4140', 'PORCENTAJE'),
        ('23680108', 'CON RTE ICA DEL 0.866%', 'C', 'RETEICA', '0.8660', 'PORCENTAJE'),
        ('23680109', 'CON RTE ICA DEL 0.966%', 'C', 'RETEICA', '0.9660', 'PORCENTAJE'),
        ('23680213', 'CON RTE ICA DEL 1.38%', 'C', 'RETEICA', '1.3800', 'PORCENTAJE'),
        ('240810010219', 'DESCONTABLE DEL 19%', 'D', 'IVA', NULL, NULL),
        ('24320101', 'TASA AEROPORTUARIA', 'D', 'SUBTOTAL', NULL, NULL)
    ) AS c(codigo, descripcion, naturaleza, casilla, porcentaje, modo)
),
upsert AS (
    INSERT INTO procesador_cuentacontable (codigo, descripcion)
    SELECT codigo, descripcion FROM cuentas
    ON CONFLICT (codigo) DO UPDATE SET descripcion = EXCLUDED.descripcion
    RETURNING id, codigo
),
cuentas_enriquecidas AS (
    SELECT
        u.id AS cuenta_id,
        u.codigo,
        c.descripcion,
        c.naturaleza,
        c.casilla,
        c.porcentaje,
        c.modo
    FROM upsert u
    JOIN cuentas c USING (codigo)
),
parametros AS (
    SELECT * FROM (VALUES
        ('231051102511', '860056098'),
        ('231051102535', '900417917'),
        ('231051103011', '860069389'),
        ('231051351501', '900656593'),
        ('231051351532', '900749336'),
        ('231051401035', '860007322'),
        ('231051452530', '860023981'),
        ('231051951035', '830054539'),
        ('231051953004', '805001149'),
        ('231051953031', '79362164'),
        ('231052201032', '830054539'),
        ('231052301032', '860002503'),
        ('231052301032', '890903407'),
        ('231052351535', '900749336'),
        ('23105235351032', '800153993'),
        ('231052355003', '830505144'),
        ('231052356030', '860002464'),
        ('23105295050111', '900682258'),
        ('231053051534', '830070527'),
        ('231053059501', '860023264'),
        ('231053152007', '800153993'),
        ('231053152007', '900385136'),
        ('231053152007', '900430148'),
        ('231053152007', '900505512'),
        ('23106145200435', '830011008'),
        ('23106145200435', '830054539'),
        ('23106145200435', '899999059'),
        ('23106145200604', '800139545'),
        ('23106145200604', '892400643'),
        ('23106145200604', '900336816'),
        ('23106145200604', '900430148'),
        ('23106145200604', '900508908'),
        ('23106145200632', '830054539'),
        ('23106145200632', '830126204'),
        ('23106145200632', '860023981'),
        ('23106145200632', '890100577'),
        ('23106145200632', '900430148'),
        ('23106145200632', '901009488'),
        ('23106145200632', '901242715'),
        ('23106145201003', '900385136'),
        ('23106145201032', '900341322'),
        ('23106145201032', '900432307'),
        ('23106145201032', '901118744'),
        ('23106145201235', '900505512'),
        ('23106145201332', '901210452'),
        ('23106145303532', '890912462'),
        ('23106145303535', '860079024'),
        ('23359526', '79362164'),
        ('23359526', '800139545'),
        ('23359526', '800153993'),
        ('23359526', '805001149'),
        ('23359526', '830011008'),
        ('23359526', '830054539'),
        ('23359526', '830070527'),
        ('23359526', '830126204'),
        ('23359526', '830505144'),
        ('23359526', '860002464'),
        ('23359526', '860002503'),
        ('23359526', '860007322'),
        ('23359526', '860023264'),
        ('23359526', '860023981'),
        ('23359526', '860056098'),
        ('23359526', '860069389'),
        ('23359526', '860079024'),
        ('23359526', '890100577'),
        ('23359526', '890903407'),
        ('23359526', '890912462'),
        ('23359526', '892400643'),
        ('23359526', '899999059'),
        ('23359526', '900336816'),
        ('23359526', '900341322'),
        ('23359526', '900385136'),
        ('23359526', '900417917'),
        ('23359526', '900430148'),
        ('23359526', '900432307'),
        ('23359526', '900505512'),
        ('23359526', '900508908'),
        ('23359526', '900656593'),
        ('23359526', '900682258'),
        ('23359526', '900749336'),
        ('23359526', '901009488'),
        ('23359526', '901118744'),
        ('23359526', '901210452'),
        ('23359526', '901242715'),
        ('23651511', '860056098'),
        ('23651511', '860069389'),
        ('23652011', '900682258'),
        ('23652504', '900385136'),
        ('23652504', '900430148'),
        ('23652504', '900508908'),
        ('23652504', '901009488'),
        ('23652505', '800139545'),
        ('23652505', '805001149'),
        ('23652505', '830505144'),
        ('23652505', '860079024'),
        ('23652505', '892400643'),
        ('23652505', '900336816'),
        ('23652505', '900656593'),
        ('23652505', '900749336'),
        ('2367010212', '900417917'),
        ('23680104', '900430148'),
        ('23680108', '860056098'),
        ('23680108', '860069389'),
        ('23680108', '900508908'),
        ('23680109', '805001149'),
        ('23680109', '830505144'),
        ('23680109', '860079024'),
        ('23680109', '900336816'),
        ('23680109', '900508908'),
        ('23680109', '900656593'),
        ('23680109', '900682258'),
        ('23680109', '900749336'),
        ('23680109', '901118744'),
        ('23680213', '900430148'),
        ('23680213', '901009488'),
        ('240810010219', '800139545'),
        ('240810010219', '800153993'),
        ('240810010219', '805001149'),
        ('240810010219', '830054539'),
        ('240810010219', '830070527'),
        ('240810010219', '830126204'),
        ('240810010219', '830505144'),
        ('240810010219', '860023264'),
        ('240810010219', '860023981'),
        ('240810010219', '860056098'),
        ('240810010219', '860069389'),
        ('240810010219', '860079024'),
        ('240810010219', '890100577'),
        ('240810010219', '890903407'),
        ('240810010219', '892400643'),
        ('240810010219', '900336816'),
        ('240810010219', '900341322'),
        ('240810010219', '900385136'),
        ('240810010219', '900417917'),
        ('240810010219', '900430148'),
        ('240810010219', '900432307'),
        ('240810010219', '900505512'),
        ('240810010219', '900508908'),
        ('240810010219', '900656593'),
        ('240810010219', '900682258'),
        ('240810010219', '900749336'),
        ('240810010219', '901009488'),
        ('240810010219', '901118744'),
        ('24320101', '830054539')
    ) AS p(codigo, nit)
),
filtrados AS (
    SELECT
        prov.id AS proveedor_id,
        c.cuenta_id,
        c.casilla,
        c.naturaleza,
        c.porcentaje,
        c.modo,
        c.descripcion,
        p.nit
    FROM parametros p
    JOIN cuentas_enriquecidas c ON c.codigo = p.codigo
    JOIN procesador_proveedor prov ON prov.nit = p.nit
)
INSERT INTO procesador_cuentacontableproveedor
    (proveedor_id, cuenta_id, casilla, naturaleza, porcentaje, modo_calculo, ayuda, activo)
SELECT
    proveedor_id,
    cuenta_id,
    casilla,
    naturaleza,
    porcentaje,
    COALESCE(modo, ''),
    descripcion,
    TRUE
FROM filtrados
ON CONFLICT (proveedor_id, casilla, cuenta_id) DO UPDATE
SET
    naturaleza = EXCLUDED.naturaleza,
    porcentaje = EXCLUDED.porcentaje,
    modo_calculo = EXCLUDED.modo_calculo,
    ayuda = EXCLUDED.ayuda,
    activo = TRUE;
