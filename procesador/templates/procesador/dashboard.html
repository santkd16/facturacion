<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gestión Facturación</title>
  <style>
    .tabla-tabs { display:flex; gap:.5rem; margin-bottom:1rem; }
    .tabla-tabs button{ background:#f0f0f0; border:1px solid #ccc; border-radius:4px 4px 0 0; padding:.5rem 1rem; cursor:pointer;}
    .tabla-tabs button.active{ background:#1d70b8; color:#fff; border-color:#1d70b8;}
    .tabla-contenido{ border:1px solid #ccc; padding:1rem; border-radius:0 4px 4px 4px;}
    .tabla-oculta{ display:none; }
    table { width:100%; border-collapse:collapse; }
    th, td { border:1px solid #ddd; padding:.4rem; font-size:.95rem; }
    tfoot td { font-weight:600; }
    .w-110{ min-width:110px; }
    .btn-primario, .btn-secundario {
      border-radius:4px; padding:.4rem .75rem; cursor:pointer; font-size:.95rem;
    }
    .btn-primario { background:#1d70b8; color:#fff; border:1px solid #1d70b8; }
    .btn-secundario { background:#fff; color:#1d70b8; border:1px solid #1d70b8; }
    .btn-secundario:hover { background:#eaf2fb; }
    .btn-primario:hover { background:#155a8c; }
    td.cuenta { min-width:220px; vertical-align:top; }
    td.cuenta select { width:100%; }
    td.cuenta .ayuda { display:block; font-size:0.75rem; color:#555; margin-top:0.25rem; }
    td.cuenta .alerta { display:block; font-size:0.75rem; color:#c0392b; margin-top:0.25rem; }
    td.valor, td.valor-retencion { text-align:right; }
    td.porcentaje { text-align:right; min-width:90px; }
    td.estado-listo { text-align:center; white-space:nowrap; }
    td.estado-listo label { display:flex; align-items:center; justify-content:center; gap:.35rem; font-size:.85rem; }
    td.estado-listo input { accent-color:#1d70b8; }
    .fila-lista { background:#f5fbf0; }
    .panel-filtros { border:1px solid #ccc; border-radius:6px; padding:0.75rem 1rem; margin:0.75rem 0; background:#f9fbfd; }
    .panel-filtros__contenedor { display:flex; flex-wrap:wrap; gap:1rem; align-items:flex-end; }
    .panel-filtros label { display:flex; flex-direction:column; font-size:0.85rem; color:#333; }
    .panel-filtros input[type="date"], .panel-filtros select { padding:0.35rem 0.5rem; border:1px solid #bbb; border-radius:4px; min-width:180px; }
    .panel-filtros__acciones { display:flex; gap:.5rem; }
    .panel-filtros__check { display:flex; align-items:center; gap:0.35rem; font-size:0.9rem; cursor:pointer; }
    .panel-filtros__check input { margin:0; accent-color:#1d70b8; }
  </style>
</head>
<body>
  <header style="display:flex; justify-content:space-between; align-items:center; background:#1d70b8; color:#fff; padding:1rem 1.5rem; border-radius:6px;">
    <div>
      <h1 style="margin:0;">Gestión Facturación</h1>
      <p style="margin:0.25rem 0 0; font-size:0.95rem;">Empresa actual: <strong>{{ empresa.nombre }}</strong></p>
    </div>
    <div style="text-align:right; font-size:0.9rem;">
      <p style="margin:0;">{{ request.user.get_full_name|default:request.user.username }}</p>
      <a href="{% url 'seleccionar_empresa' %}" style="color:#fff; text-decoration:underline; margin-right:1rem;">Cambiar empresa</a>
      <form method="post" action="{% url 'logout' %}" style="display:inline;">
        {% csrf_token %}
        <button type="submit" style="background:none; border:none; color:#fff; text-decoration:underline; cursor:pointer; padding:0; font:inherit;">
          Cerrar sesión
        </button>
      </form>
    </div>
  </header>

  {% if messages %}
  <div style="margin:1rem 0;">
    {% for message in messages %}
      <div style="padding:0.75rem 1rem; border-radius:4px; margin-bottom:0.5rem; background:{% if message.tags == 'error' %}#fdecea{% elif message.tags == 'success' %}#e6f4ea{% else %}#eef5fb{% endif %}; color:{% if message.tags == 'error' %}#c0392b{% elif message.tags == 'success' %}#1e7e34{% else %}#31708f{% endif %};">
        {{ message }}
      </div>
    {% endfor %}
  </div>
  {% endif %}

  <h3>Subir Excel</h3>
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form_excel.as_p }}
    <button type="submit" name="upload_excel">Cargar Excel</button>
  </form>

  <h3>Subir ZIP con XML</h3>
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form_zip.as_p }}
    <button type="submit" name="upload_zip">Cargar ZIP</button>
  </form>

  <hr>

  <div class="tabla-tabs" role="tablist" aria-label="Tablas de facturas">
    <button type="button" role="tab" id="tab-excel" aria-controls="tabla-excel"
            class="active" aria-pressed="true" aria-selected="true">
      Facturas desde Excel
    </button>
    <button type="button" role="tab" id="tab-xml" aria-controls="tabla-xml"
            aria-pressed="false" aria-selected="false">
      Facturas desde XML
    </button>
    <button type="button" role="tab" id="tab-liq" aria-controls="tabla-liq"
            aria-pressed="false" aria-selected="false">
      Liquidación de facturas
    </button>
  </div>

  <!-- EXISTENTE: Excel -->
  <div id="tabla-excel" class="tabla-contenido" role="tabpanel"
       aria-labelledby="tab-excel">
    <h2>Facturas desde Excel</h2>
    <table>
      <thead>
        <tr>
          <th>Tipo Documento</th><th>CUFE/CUDE</th><th>Folio</th><th>Prefijo</th>
          <th>NIT Emisor</th><th>Nombre Emisor</th><th>Fecha documento</th>
          <th>IVA</th><th>INC</th><th>Total</th><th>Activo (XML)</th>
        </tr>
      </thead>
      <tbody>
        {% for factura in facturas_xls %}
        <tr>
          <td>{{ factura.tipo_documento }}</td>
          <td>{{ factura.cufe }}</td>
          <td>{{ factura.folio }}</td>
          <td>{{ factura.prefijo }}</td>
          <td>{{ factura.nit_emisor }}</td>
          <td>{{ factura.nombre_emisor }}</td>
          <td>{{ factura.fecha_documento|date:'Y-m-d' }}</td>
          <td>{{ factura.iva }}</td>
          <td>{{ factura.inc }}</td>
          <td>{{ factura.total }}</td>
          <td>{% if factura.activo %}✅ Sí{% else %}❌ No{% endif %}</td>
        </tr>
        {% empty %}
        <tr><td colspan="11">No hay facturas desde Excel cargadas.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- EXISTENTE: XML -->
  <div id="tabla-xml" class="tabla-contenido tabla-oculta" role="tabpanel"
       aria-labelledby="tab-xml" hidden>
    <h2>Facturas desde XML</h2>
    <table>
      <thead>
        <tr>
          <th>CUFE</th><th>Fecha</th><th>Descripción</th><th>Subtotal</th>
          <th>IVA</th><th>Total</th><th>Proveedor</th>
        </tr>
      </thead>
      <tbody>
        {% for factura in facturas_xml %}
        <tr>
          <td>{{ factura.cufe }}</td>
          <td>{{ factura.fecha }}</td>
          <td>{{ factura.descripcion }}</td>
          <td>{{ factura.subtotal }}</td>
          <td>{{ factura.iva }}</td>
          <td>{{ factura.total }}</td>
          <td>{{ factura.proveedor.nombre }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="7">No hay facturas XML cargadas.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- NUEVO: LIQUIDACIÓN -->
  <div id="tabla-liq" class="tabla-contenido tabla-oculta" role="tabpanel"
       aria-labelledby="tab-liq" hidden>
    <div style="display:flex; justify-content:space-between; align-items:center; gap:1rem;">
      <h2 style="margin:0;">Liquidación de facturas</h2>
      <div style="display:flex; gap:.5rem; align-items:center;">
        <button type="button" id="btn-filtros" class="btn-secundario" aria-controls="panel-filtros" aria-expanded="false">Filtros</button>
        <button type="button" id="btn-validar" class="btn-primario">Validar selección</button>
        <button type="button" id="btn-exportar" class="btn-secundario">Descargar CSV</button>
      </div>
    </div>

    <div id="liquidacion-mensajes" role="status" aria-live="polite" style="margin:.75rem 0;"></div>

    <div id="panel-filtros" class="panel-filtros" hidden>
      <div class="panel-filtros__contenedor">
        <label>
          Fecha desde
          <input type="date" id="filtro-fecha-desde">
        </label>
        <label>
          Fecha hasta
          <input type="date" id="filtro-fecha-hasta">
        </label>
        <label>
          Proveedor
          <select id="filtro-proveedor">
            <option value="">Todos</option>
            {% for proveedor in liquidacion_proveedores %}
            <option value="{{ proveedor.id }}">{{ proveedor.nombre }}</option>
            {% endfor %}
          </select>
        </label>
        <label class="panel-filtros__check">
          <input type="checkbox" id="filtro-listo">
          <span>Solo proveedores listos</span>
        </label>
        <div class="panel-filtros__acciones">
          <button type="button" id="btn-aplicar-filtros" class="btn-primario">Aplicar</button>
          <button type="button" id="btn-limpiar-filtros" class="btn-secundario">Limpiar</button>
        </div>
      </div>
    </div>

    <div style="overflow-x:auto;">
      <table id="tabla-liquidacion">
        <thead>
          <tr>
            <th>Tipo documento</th>
            <th>CUFE/CUDE</th>
            <th>NIT</th>
            <th>Proveedor</th>
            <th>Listo</th>
            <th>Fecha</th>
            <th>Descripción</th>
            <th>Prefijo + Folio</th>
            <th>Sub total</th>
            <th>Sub total – Cuenta contable</th>
            <th>IVA</th>
            <th>IVA – Cuenta contable</th>
            <th>INC</th>
            <th>INC – Cuenta contable</th>
            <th>ReteFuente (%)</th>
            <th>ReteFuente (valor)</th>
            <th>ReteFuente – Cuenta contable</th>
            <th>ReteICA (%)</th>
            <th>ReteICA (valor)</th>
            <th>ReteICA – Cuenta contable</th>
            <th>ReteIva (%)</th>
            <th>ReteIva (valor)</th>
            <th>ReteIva – Cuenta contable</th>
            <th>Total neto</th>
            <th>Total neto – Cuenta contable</th>
          </tr>
        </thead>
        <tbody id="tbody-liq">
          {% for fila in liquidacion_filas %}
          <tr
            data-factura-id="{{ fila.factura_id }}"
            data-proveedor-id="{{ fila.proveedor_id|default:'' }}"
            data-tipo-documento="{{ fila.tipo_documento }}"
            data-cufe="{{ fila.cufe }}"
            data-nit="{{ fila.nit }}"
            data-proveedor="{{ fila.proveedor_nombre }}"
            data-fecha="{{ fila.fecha }}"
            data-descripcion="{{ fila.descripcion|default:'' }}"
            data-prefijo-folio="{{ fila.prefijo_folio|default:'' }}"
            data-subtotal="{{ fila.subtotal_raw }}"
            data-iva="{{ fila.iva_raw }}"
            data-inc="{{ fila.inc_raw }}"
            data-total-neto-base="{{ fila.total_neto_raw }}"
            data-listo="false"
          >
            <td>{{ fila.tipo_documento }}</td>
            <td>{{ fila.cufe }}</td>
            <td>{{ fila.nit }}</td>
            <td>{{ fila.proveedor_nombre }}</td>
            <td class="estado-listo">
              <label>
                <input type="checkbox" class="marca-listo" aria-label="Marcar como listo para descarga">
                <span>OK</span>
              </label>
            </td>
            <td>{{ fila.fecha }}</td>
            <td>{{ fila.descripcion_display }}</td>
            <td>{{ fila.prefijo_folio }}</td>
            <td class="valor" data-campo="SUBTOTAL">{{ fila.subtotal }}</td>
            <td class="cuenta">
              <select class="cuenta-select" data-casilla="SUBTOTAL">
                <option value="">Seleccione cuenta</option>
              </select>
              <small class="ayuda">{{ liquidacion_casilla_help.SUBTOTAL }}</small>
              <small class="alerta" hidden></small>
            </td>
            <td class="valor" data-campo="IVA">{{ fila.iva }}</td>
            <td class="cuenta">
              <select class="cuenta-select" data-casilla="IVA">
                <option value="">Seleccione cuenta</option>
              </select>
              <small class="ayuda">{{ liquidacion_casilla_help.IVA }}</small>
              <small class="alerta" hidden></small>
            </td>
            <td class="valor" data-campo="INC">{{ fila.inc }}</td>
            <td class="cuenta">
              <select class="cuenta-select" data-casilla="INC">
                <option value="">Seleccione cuenta</option>
              </select>
              <small class="ayuda">{{ liquidacion_casilla_help.INC }}</small>
              <small class="alerta" hidden></small>
            </td>
            <td class="porcentaje" data-casilla="RETEFUENTE">0.0000</td>
            <td class="valor-retencion" data-casilla="RETEFUENTE">0.00</td>
            <td class="cuenta">
              <select class="cuenta-select" data-casilla="RETEFUENTE">
                <option value="">Seleccione cuenta</option>
              </select>
              <small class="ayuda">{{ liquidacion_casilla_help.RETEFUENTE }}</small>
              <small class="alerta" hidden></small>
            </td>
            <td class="porcentaje" data-casilla="RETEICA">0.0000</td>
            <td class="valor-retencion" data-casilla="RETEICA">0.00</td>
            <td class="cuenta">
              <select class="cuenta-select" data-casilla="RETEICA">
                <option value="">Seleccione cuenta</option>
              </select>
              <small class="ayuda">{{ liquidacion_casilla_help.RETEICA }}</small>
              <small class="alerta" hidden></small>
            </td>
            <td class="porcentaje" data-casilla="RETEIVA">0.0000</td>
            <td class="valor-retencion" data-casilla="RETEIVA">0.00</td>
            <td class="cuenta">
              <select class="cuenta-select" data-casilla="RETEIVA">
                <option value="">Seleccione cuenta</option>
              </select>
              <small class="ayuda">{{ liquidacion_casilla_help.RETEIVA }}</small>
              <small class="alerta" hidden></small>
            </td>
            <td class="valor" data-campo="TOTAL_NETO">{{ fila.total_neto }}</td>
            <td class="cuenta">
              <select class="cuenta-select" data-casilla="TOTAL_NETO">
                <option value="">Seleccione cuenta</option>
              </select>
              <small class="ayuda">{{ liquidacion_casilla_help.TOTAL_NETO }}</small>
              <small class="alerta" hidden></small>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="24">No hay datos para liquidación.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // Tabs simples
    (function () {
      const tabs = document.querySelectorAll('.tabla-tabs button');
      const panels = document.querySelectorAll('.tabla-contenido');
      tabs.forEach((tab) => {
        tab.addEventListener('click', () => {
          const targetId = tab.getAttribute('aria-controls');
          tabs.forEach(btn => btn.classList.toggle('active', btn === tab));
          panels.forEach(panel => {
            panel.classList.toggle('tabla-oculta', panel.id !== targetId);
            panel.toggleAttribute('hidden', panel.id !== targetId);
          });
        });
      });
    })();

    const CSRF_TOKEN = '{{ csrf_token }}';
    const CASILLA_KEYS = {
      SUBTOTAL: 'subtotales',
      IVA: 'iva',
      INC: 'inc',
      RETEFUENTE: 'retefuente',
      RETEICA: 'reteica',
      RETEIVA: 'reteiva',
      TOTAL_NETO: 'totalneto',
    };
    const CASILLA_FIELD_MAP = {
      SUBTOTAL: 'subtotal',
      IVA: 'iva',
      INC: 'inc',
      RETEFUENTE: 'retefuente',
      RETEICA: 'reteica',
      RETEIVA: 'reteiva',
      TOTAL_NETO: 'total_neto',
    };
    const CASILLAS_VALOR_FIJO = ['SUBTOTAL', 'IVA', 'INC', 'TOTAL_NETO'];
    const RETENCIONES = new Set(['RETEFUENTE', 'RETEICA', 'RETEIVA']);
    const catalogCache = new Map();

    function formatearNumero(valor, decimales = 2) {
      return Number(valor || 0).toLocaleString('es-CO', {
        minimumFractionDigits: decimales,
        maximumFractionDigits: decimales,
      });
    }

    function esCero(valor) {
      return Math.abs(Number(valor || 0)) < 0.00005;
    }

    function refrescarEstadoSelects(tr, totales) {
      const mapaValores = {
        SUBTOTAL: totales.subtotal,
        IVA: totales.iva,
        INC: totales.inc,
        TOTAL_NETO: totales.totalNeto,
      };

      tr.querySelectorAll('select.cuenta-select').forEach((select) => {
        const td = select.closest('td');
        if (!td) return;
        const casilla = select.dataset.casilla;
        if (td.dataset.sinOpciones === 'true') {
          select.disabled = true;
          select.value = '';
          td.dataset.mensajeAuto = 'sin_opciones';
          establecerMensajeCampo(td, 'Proveedor sin parametrización. Cuenta contable = N/A.');
          return;
        }

        if (CASILLAS_VALOR_FIJO.includes(casilla)) {
          const valor = mapaValores[casilla];
          if (esCero(valor)) {
            if (select.value) {
              select.value = '';
            }
            select.disabled = true;
            td.dataset.mensajeAuto = 'valor_cero';
            establecerMensajeCampo(td, 'Valor en 0 → Cuenta contable = N/A.');
            return;
          }
          select.disabled = false;
          if (td.dataset.mensajeAuto === 'valor_cero') {
            establecerMensajeCampo(td, '');
            td.dataset.mensajeAuto = '';
          }
          return;
        }

        if (td.dataset.mensajeAuto === 'valor_cero') {
          establecerMensajeCampo(td, '');
          td.dataset.mensajeAuto = '';
        }
      });
    }

    function mostrarMensaje(contenido, tipo = 'info') {
      const contenedor = document.getElementById('liquidacion-mensajes');
      if (!contenedor) return;
      if (!contenido) {
        contenedor.innerHTML = '';
        return;
      }
      const colores = {
        error: '#fdecea',
        info: '#eef5fb',
        success: '#e6f4ea',
      };
      const colorTexto = {
        error: '#c0392b',
        info: '#31708f',
        success: '#1e7e34',
      };
      contenedor.innerHTML = `<div style="padding:.75rem 1rem; border-radius:4px; background:${colores[tipo] || colores.info}; color:${colorTexto[tipo] || colorTexto.info};">${contenido}</div>`;
    }

    function establecerMensajeCampo(td, mensaje) {
      const alerta = td.querySelector('.alerta');
      if (!alerta) return;
      if (mensaje) {
        alerta.textContent = mensaje;
        alerta.hidden = false;
      } else {
        alerta.textContent = '';
        alerta.hidden = true;
      }
    }

    function calcularRetencion(base, porcentaje, modo) {
      const tasa = Number(porcentaje || 0);
      if (modo === 'PORMIL') {
        return base * (tasa / 1000);
      }
      return base * (tasa / 100);
    }

    function recalcularTotales(tr) {
      const subtotal = Number(tr.dataset.subtotal || '0');
      const iva = Number(tr.dataset.iva || '0');
      const inc = Number(tr.dataset.inc || '0');

      let retefuente = 0;
      let reteica = 0;
      let reteiva = 0;

      ['RETEFUENTE', 'RETEICA', 'RETEIVA'].forEach((casilla) => {
        const cellValor = tr.querySelector(`.valor-retencion[data-casilla="${casilla}"]`);
        const cellPorcentaje = tr.querySelector(`.porcentaje[data-casilla="${casilla}"]`);
        const select = tr.querySelector(`select[data-casilla="${casilla}"]`);
        if (!cellValor || !cellPorcentaje || !select) return;
        const opcion = select.selectedOptions[0];
        if (!opcion || !opcion.value) {
          cellPorcentaje.textContent = '0.0000';
          cellValor.textContent = '0.00';
          return;
        }
        const porcentaje = Number(opcion.dataset.porcentaje || '0');
        const modo = opcion.dataset.modoCalculo || 'PORCENTAJE';
        const valor = calcularRetencion(subtotal, porcentaje, modo);
        cellPorcentaje.textContent = formatearNumero(porcentaje, 4);
        cellValor.textContent = formatearNumero(valor, 2);
        if (casilla === 'RETEFUENTE') retefuente = valor;
        if (casilla === 'RETEICA') reteica = valor;
        if (casilla === 'RETEIVA') reteiva = valor;
      });

      const totalNeto = subtotal + iva + inc - retefuente - reteica - reteiva;
      const totalCell = tr.querySelector('.valor[data-campo="TOTAL_NETO"]');
      if (totalCell) {
        totalCell.textContent = formatearNumero(totalNeto, 2);
      }
      return { subtotal, iva, inc, retefuente, reteica, reteiva, totalNeto };
    }

    async function cargarCatalogos(proveedorId) {
      if (!proveedorId) return null;
      if (catalogCache.has(proveedorId)) {
        return catalogCache.get(proveedorId);
      }
      try {
        const respuesta = await fetch(`/liquidacion/${proveedorId}/catalogos/`, {
          headers: { 'Accept': 'application/json' },
        });
        if (!respuesta.ok) {
          return null;
        }
        const datos = await respuesta.json();
        catalogCache.set(proveedorId, datos.catalogos || {});
        return datos.catalogos || {};
      } catch (error) {
        console.error('Error al cargar catálogos', error);
        return null;
      }
    }

    function poblarSelect(select, opciones, casilla) {
      const td = select.closest('td');
      establecerMensajeCampo(td, '');
      const valorAnterior = select.value;
      select.innerHTML = '<option value="">Seleccione cuenta</option>';
      if (!opciones || !opciones.length) {
        td.dataset.sinOpciones = 'true';
        td.dataset.mensajeAuto = 'sin_opciones';
        select.disabled = true;
        establecerMensajeCampo(td, 'Proveedor sin parametrización. Cuenta contable = N/A.');
        return;
      }
      td.dataset.sinOpciones = 'false';
      td.dataset.mensajeAuto = '';
      select.disabled = false;
      opciones.forEach((item) => {
        const opcion = document.createElement('option');
        opcion.value = item.id;
        let texto = `${item.codigo} - ${item.descripcion}`;
        if (RETENCIONES.has(casilla)) {
          const sufijo = item.modo_calculo === 'PORMIL' ? '‰' : '%';
          texto += ` (${(item.porcentaje || '0.0000')}${sufijo})`;
        }
        opcion.textContent = texto;
        opcion.dataset.porcentaje = item.porcentaje || '0';
        opcion.dataset.modoCalculo = item.modo_calculo || 'PORCENTAJE';
        opcion.dataset.naturaleza = item.naturaleza || '';
        select.appendChild(opcion);
      });
      if (opciones.length === 1) {
        select.value = opciones[0].id;
        td.dataset.mensajeAuto = 'auto';
        establecerMensajeCampo(td, 'Seleccionado automáticamente por única opción.');
      } else if (valorAnterior) {
        select.value = valorAnterior;
      }
    }

    async function inicializarFila(tr) {
      const proveedorId = tr.dataset.proveedorId;
      const selects = tr.querySelectorAll('select.cuenta-select');
      if (!proveedorId) {
        selects.forEach((select) => {
          select.disabled = true;
          const td = select.closest('td');
          if (td) {
            td.dataset.sinOpciones = 'true';
            td.dataset.mensajeAuto = 'sin_opciones';
            establecerMensajeCampo(td, 'No hay proveedor asociado. Cuenta contable = N/A.');
          }
        });
        const totales = recalcularTotales(tr);
        refrescarEstadoSelects(tr, totales);
        return;
      }
      const catalogos = await cargarCatalogos(proveedorId);
      selects.forEach((select) => {
        const casilla = select.dataset.casilla;
        const clave = CASILLA_KEYS[casilla];
        const opciones = catalogos && catalogos[clave] ? catalogos[clave] : [];
        poblarSelect(select, opciones, casilla);
      });
      const totales = recalcularTotales(tr);
      refrescarEstadoSelects(tr, totales);
    }

    document.querySelectorAll('#tbody-liq tr').forEach((tr) => {
      inicializarFila(tr);
    });

    document.addEventListener('change', (evento) => {
      if (evento.target.matches('#tbody-liq select.cuenta-select')) {
        const tr = evento.target.closest('tr');
        if (!tr) return;
        const totales = recalcularTotales(tr);
        refrescarEstadoSelects(tr, totales);
      }
      if (evento.target.matches('.marca-listo')) {
        const tr = evento.target.closest('tr');
        if (!tr) return;
        const marcado = evento.target.checked;
        tr.dataset.listo = marcado ? 'true' : 'false';
        tr.classList.toggle('fila-lista', marcado);
        aplicarFiltros();
      }
    });

    function recolectarFilas() {
      const filas = [];
      document.querySelectorAll('#tbody-liq tr').forEach((tr) => {
        const totales = recalcularTotales(tr);
        refrescarEstadoSelects(tr, totales);
        const fila = {
          factura_id: tr.dataset.facturaId || null,
          proveedor_id: tr.dataset.proveedorId ? Number(tr.dataset.proveedorId) : null,
          tipo_documento: tr.dataset.tipoDocumento || '',
          cufe: tr.dataset.cufe || '',
          nit: tr.dataset.nit || '',
          proveedor: tr.dataset.proveedor || '',
          fecha: tr.dataset.fecha || '',
          descripcion: tr.dataset.descripcion || '',
          prefijo_folio: tr.dataset.prefijoFolio || '',
          importes: {},
          cuentas: {},
          porcentajes: {},
        };
        ['SUBTOTAL', 'IVA', 'INC', 'TOTAL_NETO'].forEach((casilla) => {
          const campo = {
            SUBTOTAL: 'subtotal',
            IVA: 'iva',
            INC: 'inc',
            TOTAL_NETO: 'total_neto',
          }[casilla];
          const valor = casilla === 'TOTAL_NETO' ? totales.totalNeto : Number(tr.dataset[campo.replace('_', '')] || totales[campo]);
          fila.importes[campo] = formatearNumero(valor, 2);
          const select = tr.querySelector(`select[data-casilla="${casilla}"]`);
          fila.cuentas[campo] = select && select.value ? Number(select.value) : null;
        });
        ['RETEFUENTE', 'RETEICA', 'RETEIVA'].forEach((casilla) => {
          const campo = CASILLA_FIELD_MAP[casilla];
          const select = tr.querySelector(`select[data-casilla="${casilla}"]`);
          const porcentajeEl = tr.querySelector(`.porcentaje[data-casilla="${casilla}"]`);
          const valorEl = tr.querySelector(`.valor-retencion[data-casilla="${casilla}"]`);
          fila.importes[campo] = valorEl ? valorEl.textContent : '0.00';
          fila.porcentajes[campo] = porcentajeEl ? porcentajeEl.textContent : '0.0000';
          fila.cuentas[campo] = select && select.value ? Number(select.value) : null;
        });
        filas.push(fila);
      });
      return filas;
    }

    const panelFiltros = document.getElementById('panel-filtros');
    const btnFiltros = document.getElementById('btn-filtros');
    const filtroFechaDesde = document.getElementById('filtro-fecha-desde');
    const filtroFechaHasta = document.getElementById('filtro-fecha-hasta');
    const filtroProveedor = document.getElementById('filtro-proveedor');
    const filtroListo = document.getElementById('filtro-listo');

    function aplicarFiltros() {
      const desde = filtroFechaDesde?.value || '';
      const hasta = filtroFechaHasta?.value || '';
      const proveedor = filtroProveedor?.value || '';
      const soloListos = filtroListo?.checked || false;

      document.querySelectorAll('#tbody-liq tr').forEach((tr) => {
        let visible = true;
        const fecha = tr.dataset.fecha || '';
        if (desde) {
          if (!fecha || fecha < desde) {
            visible = false;
          }
        }
        if (visible && hasta) {
          if (!fecha || fecha > hasta) {
            visible = false;
          }
        }
        if (visible && proveedor) {
          if (tr.dataset.proveedorId !== proveedor) {
            visible = false;
          }
        }
        if (visible && soloListos) {
          if (tr.dataset.listo !== 'true') {
            visible = false;
          }
        }
        tr.style.display = visible ? '' : 'none';
      });
    }

    function limpiarFiltros() {
      if (filtroFechaDesde) filtroFechaDesde.value = '';
      if (filtroFechaHasta) filtroFechaHasta.value = '';
      if (filtroProveedor) filtroProveedor.value = '';
      if (filtroListo) filtroListo.checked = false;
      aplicarFiltros();
    }

    btnFiltros?.addEventListener('click', () => {
      if (!panelFiltros) return;
      const estabaOculto = panelFiltros.hasAttribute('hidden');
      panelFiltros.toggleAttribute('hidden');
      btnFiltros.setAttribute('aria-expanded', estabaOculto ? 'true' : 'false');
      if (estabaOculto) {
        aplicarFiltros();
      }
    });

    document.getElementById('btn-aplicar-filtros')?.addEventListener('click', aplicarFiltros);
    document.getElementById('btn-limpiar-filtros')?.addEventListener('click', limpiarFiltros);

    [filtroFechaDesde, filtroFechaHasta, filtroProveedor, filtroListo].forEach((elemento) => {
      elemento?.addEventListener('change', aplicarFiltros);
    });

    async function validarFilas() {
      mostrarMensaje('Validando…', 'info');
      const filas = recolectarFilas();
      try {
        const respuesta = await fetch('{% url "liquidacion_validar" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CSRF_TOKEN,
          },
          body: JSON.stringify({ filas }),
        });
        const datos = await respuesta.json();
        if (respuesta.ok) {
          mostrarMensaje('La validación se completó correctamente.', 'success');
          return { filas: datos.filas || filas, valido: true };
        }
        const errores = datos.errores || [];
        if (!errores.length) {
          mostrarMensaje('La validación no se pudo completar.', 'error');
          return { filas, valido: false };
        }
        const mensajes = errores.map((err) => `Fila ${err.fila + 1 || ''}: ${err.mensaje}`).join('<br>');
        mostrarMensaje(mensajes, 'error');
        return { filas, valido: false };
      } catch (error) {
        console.error('Error de validación', error);
        mostrarMensaje('No fue posible validar la información.', 'error');
        return { filas, valido: false };
      }
    }

    document.getElementById('btn-validar')?.addEventListener('click', () => {
      validarFilas();
    });

    document.getElementById('btn-exportar')?.addEventListener('click', async () => {
      const resultado = await validarFilas();
      if (!resultado || !resultado.valido) {
        return;
      }
      const payload = encodeURIComponent(JSON.stringify({ filas: resultado.filas }));
      window.location.href = `{% url "liquidacion_exportar" %}?formato=csv&payload=${payload}`;
    });
  </script>
</body>
</html>