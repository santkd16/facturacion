<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gestión Facturación</title>
  <style>
    .tabla-tabs { display:flex; gap:.5rem; margin-bottom:1rem; }
    .tabla-tabs button{ background:#f0f0f0; border:1px solid #ccc; border-radius:4px 4px 0 0; padding:.5rem 1rem; cursor:pointer;}
    .tabla-tabs button.active{ background:#1d70b8; color:#fff; border-color:#1d70b8;}
    .tabla-contenido{ border:1px solid #ccc; padding:1rem; border-radius:0 4px 4px 4px;}
    .tabla-oculta{ display:none; }
    table { width:100%; border-collapse:collapse; }
    th, td { border:1px solid #ddd; padding:.4rem; font-size:.95rem; }
    tfoot td { font-weight:600; }
    .w-110{ min-width:110px; }
  </style>
</head>
<body>
  <h1>Gestión Facturación</h1>

  <h3>Subir Excel</h3>
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form_excel.as_p }}
    <button type="submit" name="upload_excel">Cargar Excel</button>
  </form>

  <h3>Subir ZIP con XML</h3>
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form_zip.as_p }}
    <button type="submit" name="upload_zip">Cargar ZIP</button>
  </form>

  <hr>

  <div class="tabla-tabs" role="tablist" aria-label="Tablas de facturas">
    <button type="button" role="tab" id="tab-excel" aria-controls="tabla-excel"
            class="active" aria-pressed="true" aria-selected="true">
      Facturas desde Excel
    </button>
    <button type="button" role="tab" id="tab-xml" aria-controls="tabla-xml"
            aria-pressed="false" aria-selected="false">
      Facturas desde XML
    </button>
    <button type="button" role="tab" id="tab-liq" aria-controls="tabla-liq"
            aria-pressed="false" aria-selected="false">
      Liquidación de facturas
    </button>
  </div>

  <!-- EXISTENTE: Excel -->
  <div id="tabla-excel" class="tabla-contenido" role="tabpanel"
       aria-labelledby="tab-excel">
    <h2>Facturas desde Excel</h2>
    <table>
      <thead>
        <tr>
          <th>Tipo Documento</th><th>CUFE/CUDE</th><th>Folio</th><th>Prefijo</th>
          <th>NIT Emisor</th><th>Nombre Emisor</th><th>Fecha documento</th>
          <th>IVA</th><th>INC</th><th>Total</th><th>Activo (XML)</th>
        </tr>
      </thead>
      <tbody>
        {% for factura in facturas_xls %}
        <tr>
          <td>{{ factura.tipo_documento }}</td>
          <td>{{ factura.cufe }}</td>
          <td>{{ factura.folio }}</td>
          <td>{{ factura.prefijo }}</td>
          <td>{{ factura.nit_emisor }}</td>
          <td>{{ factura.nombre_emisor }}</td>
          <td>{{ factura.fecha_documento|date:'Y-m-d' }}</td>
          <td>{{ factura.iva }}</td>
          <td>{{ factura.inc }}</td>
          <td>{{ factura.total }}</td>
          <td>{% if factura.activo %}✅ Sí{% else %}❌ No{% endif %}</td>
        </tr>
        {% empty %}
        <tr><td colspan="11">No hay facturas desde Excel cargadas.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- EXISTENTE: XML -->
  <div id="tabla-xml" class="tabla-contenido tabla-oculta" role="tabpanel"
       aria-labelledby="tab-xml" hidden>
    <h2>Facturas desde XML</h2>
    <table>
      <thead>
        <tr>
          <th>CUFE</th><th>Fecha</th><th>Descripción</th><th>Subtotal</th>
          <th>IVA</th><th>Total</th><th>Proveedor</th>
        </tr>
      </thead>
      <tbody>
        {% for factura in facturas_xml %}
        <tr>
          <td>{{ factura.cufe }}</td>
          <td>{{ factura.fecha }}</td>
          <td>{{ factura.descripcion }}</td>
          <td>{{ factura.subtotal }}</td>
          <td>{{ factura.iva }}</td>
          <td>{{ factura.total }}</td>
          <td>{{ factura.proveedor.nombre }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="7">No hay facturas XML cargadas.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- NUEVO: LIQUIDACIÓN -->
  <div id="tabla-liq" class="tabla-contenido tabla-oculta" role="tabpanel"
       aria-labelledby="tab-liq" hidden>
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2>Liquidación de facturas</h2>
      <form id="form-liq" method="post" action="{% url 'descargar_liquidacion' %}">
        {% csrf_token %}
        <input type="hidden" name="rows_json" id="rows-json" value="[]">
        <button type="submit">Descargar CSV</button>
      </form>
    </div>

    <table>
      <thead>
        <tr>
          <th>Tipo documento</th><th>CUFE/CUDE</th><th>NIT</th><th>Proveedor</th>
          <th>Fecha</th><th>Descripción</th><th>Prefijo + Folio</th>
          <th class="w-110">Sub total</th><th class="w-110">IVA</th>
          <th class="w-110">INC</th><th class="w-110">ReteFuente (%)</th>
          <th class="w-110">ReteFuente</th><th class="w-110">ReteICA (%)</th>
          <th class="w-110">ReteICA</th><th class="w-110">Total neto</th>
        </tr>
      </thead>
      <tbody id="tbody-liq">
        {% for item in liquidaciones %}
        <tr
          data-tipo-documento="{{ item.factura.tipo_documento }}"
          data-cufe="{{ item.factura.cufe }}"
          data-nit="{{ item.nit }}"
          data-proveedor="{{ item.proveedor_nombre }}"
          data-fecha="{{ item.fecha_excel_str }}"
          data-fecha-xml="{{ item.fecha_xml|date:'Y-m-d' }}"
          data-prefijo-folio="{{ item.prefijo_folio }}"
          data-descripcion="{{ item.descripcion|default:'' }}"
          data-coincide-xml="{{ item.coincide_xml|yesno:'si,no' }}"
        >
          <td>{{ item.factura.tipo_documento }}</td>
          <td>{{ item.factura.cufe }}</td>
          <td>{{ item.nit }}</td>
          <td>{{ item.proveedor_nombre }}</td>
          <td>{{ item.fecha_excel_str }}</td>
          <td>
            {% if item.coincide_xml %}
              {{ item.descripcion_display }}
            {% else %}
              <span style="color:#c00; font-weight:600;">{{ item.descripcion_display }}</span>
            {% endif %}
          </td>
          <td>{{ item.prefijo_folio }}</td>
          <td data-sub="{{ item.subtotal }}">{{ item.subtotal|floatformat:2 }}</td>
          <td data-iva="{{ item.factura.iva }}">{{ item.factura.iva|floatformat:2 }}</td>
          <td data-inc="{{ item.factura.inc }}">{{ item.factura.inc|floatformat:2 }}</td>
          <td>
            <select class="rf">
              {% for rf in item.opciones_rf %}
              <option value="{{ rf }}" {% if rf == item.retefuente_default %}selected{% endif %}>{{ rf }}</option>
              {% endfor %}
            </select>
          </td>
          <td class="retefuente-valor">0.00</td>
          <td>
            <select class="ica">
              {% for ica in item.opciones_ica %}
              <option value="{{ ica }}" {% if ica == item.reteica_default %}selected{% endif %}>{{ ica }}</option>
              {% endfor %}
            </select>
          </td>
          <td class="reteica-valor">0.00</td>
          <td class="total-neto">0.00</td>
        </tr>
        {% empty %}
        <tr><td colspan="14">No hay datos para liquidación.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <script>
    // Tabs simples
    (function () {
      const tabs = document.querySelectorAll('.tabla-tabs button');
      const panels = document.querySelectorAll('.tabla-contenido');
      tabs.forEach((tab) => {
        tab.addEventListener('click', () => {
          const targetId = tab.getAttribute('aria-controls');
          tabs.forEach(btn => btn.classList.toggle('active', btn === tab));
          panels.forEach(panel => {
            panel.classList.toggle('tabla-oculta', panel.id !== targetId);
            panel.toggleAttribute('hidden', panel.id !== targetId);
          });
        });
      });
    })();

    // Cálculo Total Neto = subtotal + iva + inc - (subtotal*rf/100) - (subtotal*ica/100)
    function recalcularFila(tr) {
      const sub = parseFloat(tr.querySelector('[data-sub]').dataset.sub || '0') || 0;
      const iva = parseFloat(tr.querySelector('[data-iva]').dataset.iva || '0') || 0;
      const inc = parseFloat(tr.querySelector('[data-inc]').dataset.inc || '0') || 0;
      const rf = parseFloat(tr.querySelector('select.rf').value || '0') || 0;
      const ica = parseFloat(tr.querySelector('select.ica').value || '0') || 0;
      const retefuente = sub * rf / 100.0;
      const reteica = sub * ica / 100.0;
      const neto = (sub + iva + inc) - retefuente - reteica;
      const rfCell = tr.querySelector('.retefuente-valor');
      const icaCell = tr.querySelector('.reteica-valor');
      if (rfCell) {
        rfCell.textContent = retefuente.toFixed(2);
      }
      if (icaCell) {
        icaCell.textContent = reteica.toFixed(2);
      }
      tr.querySelector('.total-neto').textContent = neto.toFixed(2);
    }

    function recalcularTodo() {
      document.querySelectorAll('#tbody-liq tr').forEach(recalcularFila);
    }

    document.addEventListener('change', (e) => {
      if (e.target.closest('#tbody-liq select')) {
        const tr = e.target.closest('tr');
        recalcularFila(tr);
      }
    });

    const formLiq = document.getElementById('form-liq');
    if (formLiq) {
      formLiq.addEventListener('submit', () => {
        const rows = [];
        document.querySelectorAll('#tbody-liq tr').forEach((tr) => {
          const subCell = tr.querySelector('[data-sub]');
          const ivaCell = tr.querySelector('[data-iva]');
          const incCell = tr.querySelector('[data-inc]');
          const rfSelect = tr.querySelector('select.rf');
          const icaSelect = tr.querySelector('select.ica');
          const sub = parseFloat(subCell ? subCell.dataset.sub || '0' : '0') || 0;
          const iva = parseFloat(ivaCell ? ivaCell.dataset.iva || '0' : '0') || 0;
          const inc = parseFloat(incCell ? incCell.dataset.inc || '0' : '0') || 0;
          const rfPct = parseFloat(rfSelect ? rfSelect.value || '0' : '0') || 0;
          const icaPct = parseFloat(icaSelect ? icaSelect.value || '0' : '0') || 0;
          const retefuente = sub * rfPct / 100.0;
          const reteica = sub * icaPct / 100.0;
          const totalNeto = (sub + iva + inc) - retefuente - reteica;
          rows.push({
            tipo_documento: tr.dataset.tipoDocumento || '',
            cufe: tr.dataset.cufe || '',
            nit: tr.dataset.nit || '',
            proveedor: tr.dataset.proveedor || '',
            fecha: tr.dataset.fecha || '',
            descripcion: tr.dataset.descripcion || '',
            prefijo_folio: tr.dataset.prefijoFolio || '',
            subtotal: sub.toFixed(2),
            iva: iva.toFixed(2),
            inc: inc.toFixed(2),
            retefuente_pct: rfPct.toFixed(2),
            reteica_pct: icaPct.toFixed(2),
            retefuente: retefuente.toFixed(2),
            reteica: reteica.toFixed(2),
            total_neto: totalNeto.toFixed(2),
          });
        });
        const hiddenInput = document.getElementById('rows-json');
        if (hiddenInput) {
          hiddenInput.value = JSON.stringify(rows);
        }
      });
    }

    // Recalcular al cargar
    window.addEventListener('DOMContentLoaded', recalcularTodo);
  </script>
</body>
</html>